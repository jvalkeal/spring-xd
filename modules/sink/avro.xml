<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:int-hadoop="http://www.springframework.org/schema/integration/hadoop"
	xmlns:task="http://www.springframework.org/schema/task"
	xmlns:hdp="http://www.springframework.org/schema/hadoop"
	xsi:schemaLocation="http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/integration/hadoop http://www.springframework.org/schema/integration/hadoop/spring-integration-hadoop.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
		http://www.springframework.org/schema/hadoop http://www.springframework.org/schema/hadoop/spring-hadoop.xsd">

	<int:channel id="input"/>

	<int:aggregator
			input-channel="input"
			correlation-strategy-expression="payload.getClass().getName()"
			release-strategy-expression="size() == ${batchSize}"
			expire-groups-upon-completion="true"
			send-partial-result-on-expiry="true"
			message-store="messageStore"
			output-channel="objects"/>

	<bean id="reaper" class="org.springframework.integration.store.MessageGroupStoreReaper">
		<property name="messageGroupStore" ref="messageStore"/>
		<property name="timeout" value="${idleTimeout}"/>
		<property name="expireOnDestroy" value="true"/>
	</bean>

	<task:scheduled-tasks>
		<task:scheduled ref="reaper" method="run" fixed-rate="1000"/>
	</task:scheduled-tasks>

	<bean id="messageStore" class="org.springframework.integration.store.SimpleMessageStore">
		<property name="timeoutOnIdle" value="true"/>
	</bean>

	<int-hadoop:avro-outbound-channel-adapter id="objects" dataset-operations="datasetOperations"/>

	<!-- TODO: switch back to original class once we update to use spring-data-hadoop 2.0.0.M5
	    class="org.springframework.data.hadoop.store.dataset.DatasetTemplate" -->
    <bean id="datasetOperations" class="org.springframework.data.hadoop.x.store.dataset.DatasetTemplateAllowingNulls">
		<property name="datasetRepositoryFactory" ref="datasetRepositoryFactory"/>
	</bean>

	<bean id="datasetRepositoryFactory" class="org.springframework.data.hadoop.store.dataset.DatasetRepositoryFactory">
		<property name="conf" ref="hadoopConfiguration"/>
		<property name="basePath" value="${directory:/xd/${xd.stream.name}}"/>
	</bean>

	<hdp:configuration register-url-handler="false" properties-location="${xd.config.home}/hadoop.properties"/>

</beans>
