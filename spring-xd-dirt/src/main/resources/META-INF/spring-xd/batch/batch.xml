<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:batch="http://www.springframework.org/schema/batch"
	xmlns:jdbc="http://www.springframework.org/schema/jdbc" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:task="http://www.springframework.org/schema/task" xmlns:cloud="http://www.springframework.org/schema/cloud"
	xsi:schemaLocation="http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd
		http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
		http://www.springframework.org/schema/cloud http://www.springframework.org/schema/cloud/spring-cloud-0.1.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">


	<task:scheduler id="scheduler" pool-size="10" />

	<bean id="batchJobLocator" class="org.springframework.xd.dirt.plugins.job.BatchJobLocator">
		<property name="jdbcTemplate" ref="jdbcTemplate" />
	</bean>

	<beans profile="adminServer">

		<beans profile="hsqldb">
			<bean id="hsqldb" class="org.springframework.xd.dirt.job.HSQLServerBean">
				<property name="serverProperties">
					<props>
						<prop key="server.port">${hsql.server.port:9101}</prop>
						<prop key="server.database.0">${xd.data.home:file:${XD_HOME}/data}/jobs/${hsql.server.database:xdjobrepotest}
						</prop>
						<prop key="server.dbname.0">${hsql.server.dbname:xdjob}</prop>
					</props>
				</property>
			</bean>
			<jdbc:initialize-database data-source="dataSource"
				ignore-failures="ALL">
				<jdbc:script
					location="classpath:/org/springframework/xd/dirt/job/registry-schema-hsqldb.sql" />
			</jdbc:initialize-database>

		</beans>

		<beans profile="postgresql">

			<jdbc:initialize-database data-source="dataSource"
				ignore-failures="ALL">
				<jdbc:script
					location="classpath:/org/springframework/xd/dirt/job/registry-schema-postgresql.sql" />
			</jdbc:initialize-database>
			<jdbc:initialize-database data-source="dataSource"
				ignore-failures="ALL">
				<jdbc:script location="org/springframework/batch/core/schema-postgresql.sql" />
			</jdbc:initialize-database>

		</beans>

		<beans profile="mysql">

			<jdbc:initialize-database data-source="dataSource"
				ignore-failures="ALL">
				<jdbc:script
					location="classpath:/org/springframework/xd/dirt/job/registry-schema-mysql.sql" />
			</jdbc:initialize-database>
			<jdbc:initialize-database data-source="dataSource"
				ignore-failures="ALL">
				<jdbc:script location="org/springframework/batch/core/schema-mysql.sql" />
			</jdbc:initialize-database>

		</beans>

	</beans>

	<beans profile="adminServer">

		<bean class="org.springframework.xd.dirt.plugins.job.DistributedJobService">
			<constructor-arg ref="jobInstanceDao" />
			<constructor-arg ref="jobExecutionDao" />
			<constructor-arg ref="stepExecutionDao" />
			<constructor-arg ref="jobRepository" />
			<constructor-arg ref="jobLauncher" />
			<constructor-arg ref="batchJobLocator" />
			<constructor-arg>
				<bean
					class="org.springframework.batch.core.repository.dao.JdbcExecutionContextDao">
					<property name="jdbcTemplate" ref="jdbcTemplate" />
				</bean>
			</constructor-arg>
		</bean>

		<bean id="jobInstanceDao"
			class="org.springframework.batch.admin.service.JdbcSearchableJobInstanceDao">
			<property name="jdbcTemplate" ref="jdbcTemplate" />
		</bean>

		<bean id="jobExecutionDao"
			class="org.springframework.batch.admin.service.JdbcSearchableJobExecutionDao">
			<property name="dataSource" ref="dataSource" />
		</bean>

		<bean id="stepExecutionDao"
			class="org.springframework.batch.admin.service.JdbcSearchableStepExecutionDao">
			<property name="dataSource" ref="dataSource" />
		</bean>

	</beans>

	<beans profile="cloud" xmlns="http://www.springframework.org/schema/beans">
		<cloud:data-source id="dataSource"
			service-name="${xd.datasource.service:mysql}" />
	</beans>

</beans>
